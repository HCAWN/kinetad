<script type="text/javascript">
// Resources:
// https://github.com/diafygi/webcrypto-examples
// https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey
// http://blog.engelke.com/tag/webcrypto/
// Tested in Firefox Developer Edition

function strToArrayBuffer(str) {
	var buf = new ArrayBuffer(str.length * 2);
	var bufView = new Uint16Array(buf);
	for (var i = 0, strLen = str.length; i < strLen; i++) {
	bufView[i] = str.charCodeAt(i);
	}
	return buf;
}
function arrayBufferToString(buf) {
	return String.fromCharCode.apply(null, new Uint16Array(buf));
}
function arrayBufferToHex(buf) { // buffer is an ArrayBuffer
	return Array.prototype.map.call(new Uint8Array(buf), x => ('00' + x.toString(16)).slice(-2)).join('');
}
function hexToArrayBuffer(hex) {
	var typedArray = new Uint8Array(hex.match(/[\da-f]{2}/gi).map(function (h) {
	  return parseInt(h, 16)
	}))
	return typedArray;
}


////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

var saltBuffer = strToArrayBuffer('e85c53e7f119d41fd7895cdc9d7bb9dd');
var plainText = 'This is some plaintext';
var passphraseKey = strToArrayBuffer("I hëart årt and £$¢!");

var algoKeyGen = {
  name: 'AES-GCM',
  length: 256
};
var iv = window.crypto.getRandomValues(new Uint8Array(12));
var algoEncrypt = {
  name: 'AES-GCM',
  iv: iv,
  tagLength: 128
};
var keyUsages = [
  'encrypt',
  'decrypt'
];

window.crypto.subtle.importKey(
  'raw', 
  passphraseKey, 
  {name: 'PBKDF2'}, 
  false, 
  ['deriveBits', 'deriveKey']
).then(function(key) {
  return window.crypto.subtle.deriveKey(
	{ "name": 'PBKDF2',
	  "salt": saltBuffer,
	  "iterations": 100,
	  "hash": 'SHA-256'
	},
	key,
	{ "name": 'AES-GCM', "length": 256 },
	true,
	[ "encrypt", "decrypt" ]
  );
}).then(function(webKey) {
	return window.crypto.subtle.encrypt(algoEncrypt, webKey, strToArrayBuffer(plainText));
}).then(function (cipherText) {
	console.log('Cipher Text: ' + arrayBufferToString(cipherText));
	console.log('IV: ' + arrayBufferToString(iv));
	//console.log(passphraseKey);
});

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

var saltBuffer = strToArrayBuffer('e85c53e7f119d41fd7895cdc9d7bb9dd');
var cipherText = hexToArrayBuffer('b692b3b15ef5de6efa38d306302a3a6df8bea71a002a26818b31ea209f3768dfb4f3534ad86c2fe0553d4b3f570f23887ee6731019e5c3fb49512aed');
var passphraseKey = strToArrayBuffer("I hëart årt and £$¢!");
var Invec = hexToArrayBuffer('a9be97b971a936e8b19ff1e6');
var algoDecrypt = {
  name: 'AES-GCM',
  iv: Invec,
  tagLength: 128
};

window.crypto.subtle.importKey(
  'raw', 
  passphraseKey, 
  {name: 'PBKDF2'}, 
  false, 
  ['deriveBits', 'deriveKey']
).then(function(key) {
  return window.crypto.subtle.deriveKey(
	{ "name": 'PBKDF2',
	  "salt": saltBuffer,
	  "iterations": 100,
	  "hash": 'SHA-256'
	},
	key,
	{ "name": 'AES-GCM', "length": 256 },
	true,
	[ "encrypt", "decrypt" ]
  );
}).then(function(webKey) {
	return window.crypto.subtle.decrypt(algoDecrypt, webKey, cipherText);
}).then(function (plainText) {
	console.log('Plain Text: ' + arrayBufferToString(plainText));
}).catch (function (err) {
  console.log('Error: ' + err.message);
});

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////








</script>