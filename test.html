<script type="text/javascript">

byteArray = new Uint8Array([170, 145, 86, 162, 100, 186, 201, 226, 151, 50, 40, 184, 15, 162, 172, 164]);
function toHexString(byteArray) {
  return Array.prototype.map.call(byteArray, function(byte) {
	return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}
function toByteArray(hexString) {
  var result = [];
  while (hexString.length >= 2) {
	result.push(parseInt(hexString.substring(0, 2), 16));
	hexString = hexString.substring(2, hexString.length);
  }
  return result;
}
hexString = toHexString(byteArray);
byteArray = toByteArray(hexString);
//console.log(hexString);
//console.log(byteArray);
</script>


<script type="text/javascript">
// Resources:
// https://github.com/diafygi/webcrypto-examples
// https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey
// http://blog.engelke.com/tag/webcrypto/
// Tested in Firefox Developer Edition

function strToArrayBuffer(str) {
  var buf = new ArrayBuffer(str.length * 2);
  var bufView = new Uint16Array(buf);
  for (var i = 0, strLen = str.length; i < strLen; i++) {
	bufView[i] = str.charCodeAt(i);
  }
  return buf;
}
function arrayBufferToString(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}



// var plainText = 'This is some plaintext';
// //console.log('Plain Text: ' + plainText);




// var secretKey;
// window.crypto.subtle.generateKey(algoKeyGen, true, keyUsages).then(function (key) {
//   secretKey = key;



//   return window.crypto.subtle.encrypt(algoEncrypt, key, strToArrayBuffer(plainText));
// }).then(function (cipherText) {
//   //console.log('Cipher Text: ' + arrayBufferToString(cipherText));
//   //console.log('IV: ' + iv);
//   //console.log(secretKey);




//   return window.crypto.subtle.decrypt(algoEncrypt, secretKey, cipherText);
// }).then(function (plainText) {
//   //console.log('Plain Text: ' + arrayBufferToString(plainText));
// }).catch (function (err) {
//   console.log('Error: ' + err.message);
// });

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

var saltBuffer = strToArrayBuffer('e85c53e7f119d41fd7895cdc9d7bb9dd');
var plainText = 'This is some plaintext';
var passphraseKey = strToArrayBuffer("I hëart årt and £$¢!");

var algoKeyGen = {
  name: 'AES-GCM',
  length: 256
};
var iv = window.crypto.getRandomValues(new Uint8Array(12));
var algoEncrypt = {
  name: 'AES-GCM',
  iv: iv,
  tagLength: 128
};
var keyUsages = [
  'encrypt',
  'decrypt'
];

window.crypto.subtle.importKey(
  'raw', 
  passphraseKey, 
  {name: 'PBKDF2'}, 
  false, 
  ['deriveBits', 'deriveKey']
).then(function(key) {
  return window.crypto.subtle.deriveKey(
	{ "name": 'PBKDF2',
	  "salt": saltBuffer,
	  "iterations": 100,
	  "hash": 'SHA-256'
	},
	key,
	{ "name": 'AES-GCM', "length": 256 },
	true,
	[ "encrypt", "decrypt" ]
  );
}).then(function(webKey) {
	return window.crypto.subtle.encrypt(algoEncrypt, webKey, strToArrayBuffer(plainText));
}).then(function (cipherText) {
	console.log('Cipher Text: ' + arrayBufferToString(cipherText));
	var enc = new TextEncoder();
	console.log(enc.encode(iv));
	//console.log(passphraseKey);
});

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

var saltBuffer = strToArrayBuffer('e85c53e7f119d41fd7895cdc9d7bb9dd');
var cipherText = [73, 0, 32, 0, 104, 0, 195, 0, 171, 0, 97, 0, 114, 0, 116, 0, 32, 0, 195, 0, 165, 0, 114, 0, 116, 0, 32, 0, 97, 0, 110, 0, 100, 0, 32, 0, 194, 0, 163, 0, 36, 0, 194, 0, 162, 0, 33, 0];
var passphraseKey = strToArrayBuffer("I hëart årt and £$¢!");
var Invec = [123, 186, 94, 117, 152, 38, 26, 52, 120, 231, 137, 194];
var algoDecrypt = {
  name: 'AES-GCM',
  iv: Invec,
  tagLength: 128
};

window.crypto.subtle.importKey(
  'raw', 
  passphraseKey, 
  {name: 'PBKDF2'}, 
  false, 
  ['deriveBits', 'deriveKey']
).then(function(key) {
  return window.crypto.subtle.deriveKey(
	{ "name": 'PBKDF2',
	  "salt": saltBuffer,
	  "iterations": 100,
	  "hash": 'SHA-256'
	},
	key,
	{ "name": 'AES-GCM', "length": 256 },
	true,
	[ "encrypt", "decrypt" ]
  );
}).then(function(webKey) {
	return window.crypto.subtle.decrypt(algoDecrypt, webKey, cipherText);
}).then(function (plainText) {
	console.log('Plain Text: ' + arrayBufferToString(plainText));
}).catch (function (err) {
  console.log('Error: ' + err.message);
});

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////








</script>